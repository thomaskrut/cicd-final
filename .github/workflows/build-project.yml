name: build project

on:
 workflow_call:

jobs:
 build:
  runs-on: ubuntu-latest
  steps:
   - uses: actions/checkout@v3
   - name: Cache Gradle dependencies
     uses: actions/cache@v3
     with:
      path: |
       ~/.gradle/caches
       ~/.gradle/wrapper
      key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
      restore-keys: |
       gradle-${{ runner.os }}-
   - name: Set up JDK 17
     uses: actions/setup-java@v3
     with:
      java-version: '17'
      distribution: 'corretto'
   - name: Grant execute permission for gradlew
     run: chmod +x gradlew
   - name: Run build
     run: |
      ./gradlew build
      ./gradlew jacocoTestReport     

   - name: Add coverage to pull request
     id: jacoco
     uses: madrapps/jacoco-report@v1.6.1
     with:
       paths: |
         ${{ github.workspace }}/**/build/reports/jacoco/test/jacocoTestReport.xml,
       token: ${{ secrets.GITHUB_TOKEN }}
       min-coverage-overall: 60
       min-coverage-changed-files: 80

   - name: Fail coverage is <60%
     if: ${{ steps.jacoco.outputs.coverage-overall < 60.0 }}
     uses: actions/github-script@v6
     with:
       script: |
        core.setFailed('Overall coverage is less than 60%!')